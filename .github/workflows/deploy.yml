name: Python Deploy

on:
  push:
    branches: [ production ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deploy'
        required: false
        default: 'Manual trigger'
env:
 PROJECT_NAME: python-app

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Pull latest changes
      run: |
        git pull origin production

    - name: Build and deploy
      run: |
        # Останавливаем текущие контейнеры
        docker compose -p $PROJECT_NAME down --remove-orphans || true
        
        # Собираем новые образы
        docker compose -p $PROJECT_NAME build --no-cache
        
        # Запускаем контейнеры
        docker compose -p $PROJECT_NAME up -d
    
    - name: Fix permissions
      run:
        RUNNER_USER=$(whoami)
        RUNNER_GROUP=$(id -gn $RUNNER_USER)
        sudo chown -R $RUNNER_USER:$RUNNER_GROUP `find $GITHUB_WORKSPACE -name "__pycache__"`
        sudo chmod -R 755 `find $GITHUB_WORKSPACE -name "__pycache__"`
        echo "Fixed permissions for __pycache__"

    - name: Verify deployment
      run: |
        sleep 20
        docker compose -p $PROJECT_NAME ps
        docker compose -p $PROJECT_NAME logs --tail=30
